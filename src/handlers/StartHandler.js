const { Markup } = require('telegraf');
const { InputFile } = require('telegraf');
const path = require('path');
const fs = require('fs');
const config = require('../config');

class StartHandler {
  constructor(userService) {
    this.userService = userService;
  }

  async handle(ctx) {
    try {
      const { user, isNew } = await this.userService.createOrGetUser(ctx.from);
      const isAdmin = user.telegramId === config.ADMIN_ID;
      
      const welcomeText = '–ü—Ä–∏–≤–µ—Ç! üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à —á–∞—Ç-–±–æ—Ç, –≥–¥–µ –º–µ—á—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é! –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å Wildberries –∏ Ozon. üõçÔ∏è‚ú® –ü—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º, –∏, –≤–æ–∑–º–æ–∂–Ω–æ, –∏–º–µ–Ω–Ω–æ —Ç—ã —Å—Ç–∞–Ω–µ—à—å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º –æ–±–ª–∞–¥–∞—Ç–µ–ª–µ–º –∫—Ä—É—Ç–æ–≥–æ –ø—Ä–∏–∑–∞! –£–¥–∞—á–∏! üçÄ';
      
      const imagePath = path.join(process.cwd(), 'images', 'start.jpg');
      
      if (fs.existsSync(imagePath)) {
        try {
          await ctx.replyWithPhoto({ source: imagePath }, { caption: welcomeText });
        } catch (photoError) {
          await ctx.reply(welcomeText);
        }
      } else {
        await ctx.reply(welcomeText);
      }
      
      if (user.rulesAccepted) {
        await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', this.getMainKeyboard(isAdmin));
      } else {
        await ctx.reply('–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏:', this.getRulesKeyboard());
      }
    } catch (error) {
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  }

  getRulesKeyboard() {
    return Markup.keyboard([['üìú –û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏']]).resize();
  }

  getMainKeyboard(isAdmin = false) {
    const buttons = [
      ['üéÅ –†–æ–∑—ã–≥—Ä—ã—à', 'üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã'],
      ['üë• –†–µ—Ñ–µ—Ä–∞–ª—ã', 'üìú –ò—Å—Ç–æ—Ä–∏—è'],
      ['üí∞ –ö–æ—à–µ–ª–µ–∫']
    ];

    if (isAdmin) {
      buttons.push(['üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å']);
    }

    return Markup.keyboard(buttons).resize();
  }

  async showRules(ctx) {
    const rulesText = '–ü—Ä–∞–≤–∏–ª–∞ —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å Wildberries –∏ Ozon üéâ\n\n1. –£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ:\n   ‚Äì –î–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –±–∏–ª–µ—Ç üé´. –°—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞ –≤–∞—Ä—å–∏—Ä—É–µ—Ç—Å—è –æ—Ç 10 –¥–æ 1500 —Ä—É–±–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏–∑–∞ üí∞. –û–¥–∏–Ω —Ä–æ–∑—ã–≥—Ä—ã—à –æ–¥–∏–Ω –±–∏–ª–µ—Ç\n\n2. –ü–æ—Ä—è–¥–æ–∫ –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–∞:\n   ‚Äì –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –≤—ã–∏–≥—Ä–∞—Ç—å üèÜ.\n   ‚Äì –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã üí≥. –û–ø–ª–∞—Ç–∏—Ç–µ –±–∏–ª–µ—Ç –∏ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ\n\n3. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n   ‚Äì –î–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–±—Ä–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º üìä.\n   ‚Äì –ï—Å–ª–∏ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–±–∏—Ä–∞–µ—Ç—Å—è, –ø–æ —Ä–µ—à–µ–Ω–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ä–æ–∑—ã–≥—Ä—ã—à –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω üîÑ.\n\n4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:\n   ‚Äì –ï—Å–ª–∏ —Ä–æ–∑—ã–≥—Ä—ã—à —Å–æ—Å—Ç–æ–∏—Ç—Å—è, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –±—É–¥–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –≤—ã–±—Ä–∞–Ω —Å—Ä–µ–¥–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫—É–ø–∏–≤—à–∏—Ö –±–∏–ª–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–∑ üéâ.\n   ‚Äì –†–æ–∑—ã–≥—Ä—ã—à –±—É–¥–µ—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è ‚è∞, –æ —á–µ–º –±—É–¥–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ.\n\n5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–∏–≥—Ä—ã—à–µ:\n   ‚Äì –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–∏–≥—Ä—ã—à–µ üì©.\n   ‚Äì –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–∏–≥—Ä—ã—à–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ üì∏, –∞ —Ç–∞–∫–∂–µ –Ω–æ–º–µ—Ä —Å–≤–æ–µ–≥–æ –±–∏–ª–µ—Ç–∞.\n\n6. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–∑–∞:\n   ‚Äì –ü—Ä–∏–∑ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ üì¶ –∏–ª–∏, –ø–æ –∂–µ–ª–∞–Ω–∏—é –ø–æ–±–µ–¥–∏—Ç–µ–ª—è, –≤—ã–ø–ª–∞—á–µ–Ω –¥–µ–Ω–µ–∂–Ω–æ–π —Å—É–º–º–æ–π, —Ä–∞–≤–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ üíµ.\n   ‚Äì –í—Å–µ –¥–µ—Ç–∞–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞ –±—É–¥—É—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ü§ù.\n\n7. –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤:\n   ‚Äì –í —Å–ª—É—á–∞–µ –æ—Ç–º–µ–Ω—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –¥–µ–Ω—å–≥–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –Ω–∞ –∫–æ—à–µ–ª–µ–∫ –≤ –±–æ—Ç–µ üí≥. –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –∫–∞—Ä—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –¥—Ä—É–≥–æ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ üîÑ.\n\n8. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:\n   ‚Äì –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–≤–µ—Ä–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –±–∏–ª–µ—Ç–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–∏–∑–∞ ‚ö†Ô∏è.\n   ‚Äì –£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ ‚úÖ.\n\n9. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö:\n   ‚Äì –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ üîß. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ üì¢.';
    
    const keyboard = Markup.keyboard([['‚úÖ –Ø –æ–∑–Ω–∞–∫–æ–º–∏–ª—Å—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏']]).resize();
    
    await ctx.reply(rulesText, keyboard);
  }

  async acceptRules(ctx) {
    try {
      await this.userService.acceptRules(ctx.from.id);
      const user = await this.userService.getUser(ctx.from.id);
      const isAdmin = user.telegramId === config.ADMIN_ID;
      
      await ctx.reply('–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞! üéâ', this.getMainKeyboard(isAdmin));
    } catch (error) {
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  }
}

module.exports = StartHandler;