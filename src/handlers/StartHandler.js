const { Markup } = require('telegraf');
const { InputFile } = require('telegraf');
const path = require('path');
const fs = require('fs');
const config = require('../config');

class StartHandler {
  constructor(userService) {
    this.userService = userService;
  }

  async handle(ctx) {
    try {
      const { user, isNew } = await this.userService.createOrGetUser(ctx.from);
      const isAdmin = user.telegramId === config.ADMIN_ID;
      
      const welcomeText = '–ü—Ä–∏–≤–µ—Ç! üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à —á–∞—Ç-–±–æ—Ç, –≥–¥–µ –º–µ—á—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é! –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤ —Å Wildberries –∏ Ozon. üõçÔ∏è‚ú® –ü—Ä–æ—Å—Ç–æ —Å–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º, –∏, –≤–æ–∑–º–æ–∂–Ω–æ, –∏–º–µ–Ω–Ω–æ —Ç—ã —Å—Ç–∞–Ω–µ—à—å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º –æ–±–ª–∞–¥–∞—Ç–µ–ª–µ–º –∫—Ä—É—Ç–æ–≥–æ –ø—Ä–∏–∑–∞! –£–¥–∞—á–∏! üçÄ';
      
      const imagePath = path.join(process.cwd(), 'images', 'start.jpg');
      
      if (fs.existsSync(imagePath)) {
        try {
          await ctx.replyWithPhoto({ source: imagePath }, { caption: welcomeText });
        } catch (photoError) {
          await ctx.reply(welcomeText);
        }
      } else {
        await ctx.reply(welcomeText);
      }
      
      if (user.rulesAccepted) {
        await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', this.getMainKeyboard(isAdmin));
      } else {
        await ctx.reply('–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏:', this.getRulesKeyboard());
      }
    } catch (error) {
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  }

  getRulesKeyboard() {
    return Markup.keyboard([['üìú –û–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏']]).resize();
  }

  getMainKeyboard(isAdmin = false) {
    if (isAdmin) {
      return Markup.keyboard([['üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å']]).resize();
    }

    const buttons = [
      ['üéÅ –†–æ–∑—ã–≥—Ä—ã—à', 'üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã'],
      ['üë• –†–µ—Ñ–µ—Ä–∞–ª—ã', 'üìú –ò—Å—Ç–æ—Ä–∏—è'],
      ['üí∞ –ö–æ—à–µ–ª–µ–∫']
    ];

    return Markup.keyboard(buttons).resize();
  }

  async showRules(ctx) {
    const rulesText = '**–ü—Ä–∞–≤–∏–ª–∞ —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ —Ç–æ–≤–∞—Ä–æ–≤ Wildberries –∏ Ozon** üéâ\n\n#### 1. –£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ\n- –î–ª—è —É—á–∞—Å—Ç–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –±–∏–ª–µ—Ç üé´.\n- –°—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∏–∑–∞ –∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç 10 –¥–æ 1500 —Ä—É–±–ª–µ–π üí∞.\n- –û–¥–∏–Ω –±–∏–ª–µ—Ç = –æ–¥–∏–Ω —Ä–æ–∑—ã–≥—Ä—ã—à (—É—á–∞—Å—Ç–Ω–∏–∫ –º–æ–∂–µ—Ç –∫—É–ø–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–∏–ª–µ—Ç–æ–≤ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —à–∞–Ω—Å–æ–≤).\n\n#### 2. –ö–∞–∫ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç\n1. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–∑, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –≤—ã–∏–≥—Ä–∞—Ç—å üèÜ.\n2. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã üí≥.\n3. –û–ø–ª–∞—Ç–∏—Ç–µ –±–∏–ª–µ—Ç –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ.\n\n#### 3. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤\n- –î–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–±—Ä–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –±–∏–ª–µ—Ç–æ–≤ üìä.\n- –í –±–æ—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–∫–æ–ª—å–∫–æ –±–∏–ª–µ—Ç–æ–≤ –∫—É–ø–ª–µ–Ω–æ –∏ —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å.\n- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤ –Ω–µ –Ω–∞–±—Ä–∞–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 –¥–Ω–µ–π, —Ä–æ–∑—ã–≥—Ä—ã—à –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è, –∞ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ üîÑ.\n- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ–¥–ª–∏—Ç—å —Å—Ä–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –µ–≥–æ.\n\n#### 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è\n- –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Å—Ä–µ–¥–∏ –∫—É–ø–∏–≤—à–∏—Ö –±–∏–ª–µ—Ç—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–∑ üé≤.\n- –†–æ–∑—ã–≥—Ä—ã—à –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤ –∑–∞—Ä–∞–Ω–µ–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è ‚è∞.\n\n#### 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–∏–≥—Ä—ã—à–µ\n- –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ üì©.\n- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è:\n  - –ù–æ–º–µ—Ä –≤—ã–∏–≥—Ä—ã—à–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞.\n  - –í–∞—à –Ω–∏–∫ –¥–ª—è —Å–≤—è–∑–∏.\n- –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–±–µ–¥—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:\n  - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –±–∏–ª–µ—Ç–æ–≤ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏).\n  - –û—Ç–≤–µ—Ç–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.\n- –ï—Å–ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π, –∞ –ø—Ä–µ–∂–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–≤–µ–¥–æ–º–ª—è–µ—Ç—Å—è –æ –ø—Ä–∏—á–∏–Ω–µ –æ—Ç–º–µ–Ω—ã.\n\n#### 6. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–∑–∞\n- –ü—Ä–∏–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ Wildberries/Ozon üì¶.\n- –ü–æ –∂–µ–ª–∞–Ω–∏—é –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –≤–æ–∑–º–æ–∂–µ–Ω –¥–µ–Ω–µ–∂–Ω—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ üíµ.\n- –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã—Å—ã–ª–∞–µ—Ç QR-–∫–æ–¥ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.\n\n#### 7. –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤\n- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∞ –¥–µ–Ω—å–≥–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è:\n  - –ù–∞ –±–∞–ª–∞–Ω—Å –≤ –±–æ—Ç–µ (–¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö).\n  - –ò–ª–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É ‚Äî –Ω–∞ –∫–∞—Ä—Ç—É üí≥.\n\n#### 8. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å\n- –£—á–∞—Å—Ç–Ω–∏–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚ö†Ô∏è.\n- –£—á–∞—Å—Ç–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ ‚úÖ.\n\n#### 9. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö\n- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–ø—Ä–∞–≤–µ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è üîß.\n- –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ üì¢.';
    
    const keyboard = Markup.keyboard([['‚úÖ –Ø –æ–∑–Ω–∞–∫–æ–º–∏–ª—Å—è —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏']]).resize();
    
    await ctx.reply(rulesText, keyboard);
  }

  async acceptRules(ctx) {
    try {
      await this.userService.acceptRules(ctx.from.id);
      const user = await this.userService.getUser(ctx.from.id);
      const isAdmin = user.telegramId === config.ADMIN_ID;
      
      await ctx.reply('–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–æ—Ç–∞! üéâ', this.getMainKeyboard(isAdmin));
    } catch (error) {
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  }
}

module.exports = StartHandler;